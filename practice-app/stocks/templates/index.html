<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css"
            integrity="undefined"
            crossorigin="anonymous"
    />
    <title>Document</title>
</head>
<body>
<script type="text/javascript" src="https://canvasjs.com/assets/script/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="https://canvasjs.com/assets/script/jquery.canvasjs.min.js"></script>
<div
        class="
        container-fluid
      "
>
    <div class="row">
        <div class="currentStock col-md-4"></div>
        <div class="col-md-8">
            <form class="border p-4 d-flex" id="getData">
                <div class="form-group" style="margin: 0 10px">
                    <label for="symbols" class="col-2 col-form-label">Symbols</label>
                    <select
                            class="form-select"
                            id="symbols"
                            aria-label="Default select example"
                            onchange="selectSymbol()"
                            required
                    >
                        <option>Symbols</option>
                        <option value="AAPL">APPLE</option>
                        <option value="MSFT">MICROSOFT</option>
                        <option value="GOOG">GOOGLE CLASS C</option>
                        <option value="GOOGL">GOOGLE CLASS A</option>
                        <option value="AMZN">AMAZON</option>
                        <option value="FB">FACEBOOK</option>
                        <option value="TSLA">TESLA</option>
                        <option value="BABA">ALI BABA</option>
                    </select>
                </div>
                <div class="form-group" style="margin: 0 10px">
                    <label for="resolutions" class="col-2 col-form-label"
                    >Resolutions</label
                    >
                    <select
                            class="form-select"
                            id="resolutions"
                            aria-label="Default select example"
                            required
                    >
                        <option selected>Resolutions</option>
                        <option value="5">5</option>
                        <option value="15">15</option>
                        <option value="30">30</option>
                        <option value="60">60</option>
                        <option value="D">D</option>
                        <option value="W">W</option>
                        <option value="M">M</option>
                    </select>
                </div>
                <div class="form-group" style="margin: 0 10px">
                    <label for="example-datetime-local-input" class="col-2 col-form-label"
                    >From</label
                    >
                    <label for="from"></label><input
                        class="form-control"
                        type="datetime-local"
                        value="2021-04-03T13:45:00"
                        id="from"
                        required
                />
                </div>
                <div class="form-group" style="margin: 0 10px">
                    <label for="example-datetime-local-input" class="col-2 col-form-label"
                    >To</label
                    >
                    <label for="to"></label><input
                        class="form-control"
                        type="datetime-local"
                        value="2021-06-03T13:45:00"
                        id="to"
                        required
                />
                </div>
                <button
                        class="btn btn-primary"
                        style="height: 40px; align-self: flex-end; margin-left: 10px"
                        type="submit"
                        id="formSubmit"
                >
                    Submit
                </button>
            </form>
            <div class="w-100 border p-4">
                <div id="chartContainer" style="height: 370px; width: 100%"></div>
            </div>
            <form style="width: 80%" id="getComments">

                <div class="form-group">
                    <label>Username</label>
                    <label for="name"></label><input
                        type="text"
                        class="form-control"
                        id="name"
                        placeholder=""
                />
                </div>
                <div class="form-group">
                    <label for="exampleFormControlTextarea1">Comment</label>
                    <label for="message"></label><textarea class="form-control" id="message" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary mt-2">Submit</button>
            </form>
        </div>
    </div>

</div>

<script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
<script>
    const URL = "http://127.0.0.1:8000";
    const dataPoints = [];
    let symbolsSelect = "";
    const selectSymbol = () => {
        symbolsSelect = document.getElementById("symbols").value;
    };

    document
        .querySelector("#getData")
        .addEventListener("submit", async (e) => {
            const resolutions = document.querySelector("#resolutions").value;
            const from = document.querySelector("#from").value;
            const to = document.querySelector("#to").value;

            let myFrom = new Date(from);
            let myEpochFrom = myFrom.getTime() / 1000.0;
            let myTo = new Date(to);
            let myEpochTo = myTo.getTime() / 1000.0;

            $.getJSON(`${URL}/stocks/${symbolsSelect}/${resolutions}/${myEpochFrom}/${myEpochTo}`, getDataPoints);
            console.log(symbolsSelect);
            console.log(resolutions);
            console.log(myEpochFrom);
            console.log(myEpochTo);

            e.preventDefault();
        });

    const chart = new CanvasJS.Chart("chartContainer", {
        animationEnabled: true,
        theme: "dark2", // "light1", "light2", "dark1", "dark2"
        exportEnabled: true,

        title: {
            text: "",
        },
        subtitles: [
            {
                text: "Averages",
            },
        ],
        axisX: {
            interval: 1,
            valueFormatString: "MMM",
        },
        axisY: {
            prefix: "$",
            title: "Price",
        },
        toolTip: {
            content:
                "Date: {x}<br/><strong>Price:</strong><br />Open: {y[0]}, Close: {y[3]}<br/>High: {y[1]}, Low: {y[2]}",
        },
        data: [
            {
                type: "candlestick",
                yValueFormatString: "$##0.00",
                dataPoints: dataPoints,
            },
        ],
    });
    const getDataPoints = (res) => {
        if (dataPoints.length !== 0) {
            dataPoints.length = 0;
        }
        res.map((i) => {
            dataPoints.push({
                x: new Date(i.time * 1000),
                y: [
                    parseFloat(i.open),
                    parseFloat(i.high),
                    parseFloat(i.low),
                    parseFloat(i.close),
                ],
            });
        });
        chart.render();
    };

    window.onload = function () {
        $.getJSON(`${URL}/stocks`, createCurrentPrices);

    }

    const createCurrentPrices = (data) => {
        const stockDiv = document.querySelector(".currentStock");
        data.map((i) => {
            let divCol = document.createElement("div");
            divCol.classList.add("d-flex")
            stockDiv.appendChild(divCol);

            let symbol = document.createElement("strong");
            symbol.classList.add("font-weight-bold")
            symbol.innerHTML = i.symbol;
            divCol.appendChild(symbol);

            let current = document.createElement("p");
            current.innerHTML = "current price:  " + i.current;
            divCol.appendChild(current);

            let high = document.createElement("p");
            high.innerHTML = "high price:  " + i.high;
            divCol.appendChild(high);

            let low = document.createElement("p");
            low.innerHTML = "low price:  " + i.low;
            divCol.appendChild(low);
        });
    };
</script>
</body>
</html>
